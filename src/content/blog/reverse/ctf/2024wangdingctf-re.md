---
title: 2024ç½‘é¼æ¯é’é¾™ç»„REVERSE
author: ermu0
slug: 2024-wangdingctf-re
featured: false
draft: false
tags:
  - CTF
  - Reverse
pubDatetime: 2024-11-05T19:24:12+08:00
modDatatime: 2024-11-05T19:24:12+08:00
description: 2024ç½‘é¼æ¯é’é¾™ç»„é€†å‘é¢˜
---

ä»Šå¹´ç½‘é¼é’é¾™ç»„åˆèµ›çš„é€†å‘é¢˜è´¨é‡æœ‰ç‚¹ä¸€èˆ¬ï¼Œè€Œä¸”åªæœ‰ä¸¤é“ã€‚ä¸‹é¢ç»™å‡ºä¸¤é“é¢˜çš„è§£æä¸å¤ç°ã€‚

## REVERSE01

è¿™é“é¢˜è™½ç„¶æ˜¯å®‰å“é¢˜ï¼Œä½†æ¶‰åŠåˆ°å®‰å“ç›¸å…³çš„ä¸œè¥¿å¾ˆå°‘ï¼Œè€Œä¸”åªè¦é™æ€åˆ†æå°±èƒ½è§£å‡ºï¼Œæœ‰ç‚¹éš¾ç»·â€¦â€¦

é¦–å…ˆæ‹¿åˆ°APKå»æ£€æµ‹ä¸€ä¸‹æœ‰æ²¡æœ‰åŠ å£³ï¼Œå‘ç°æ²¡æœ‰å£³ï¼Œå¦‚ä¸‹å›¾ï¼š

![APKæŸ¥å£³](https://c.img.dasctf.com/LightPicture/2024/11/d30f4e51c526fae3.png)

### JAVAå±‚åˆ†æ

æ— å£³ï¼Œç›´æ¥æ‹–è¿›jadxæŸ¥çœ‹æºç ï¼Œå¦‚ä¸‹å›¾ï¼š

![APKæºç ](https://c.img.dasctf.com/LightPicture/2024/11/6df584c4fcd9ccef.png)

å¥½å¥½å¥½ï¼Œå‘ç°è¢«æ··æ·†äº†ï¼Œå…¶å®è¢«æ··æ·†äº†ä¹Ÿä¸ç”¨ç€æ€¥ï¼Œå› ä¸ºä¸€äº›æ–¹æ³•è¿˜æ˜¯èƒ½çœ‹å‡ºæ¥ï¼Œåˆ†æäº†ä¸€ä¸‹ï¼Œè¿™é‡Œçš„Mainæ´»åŠ¨æ²¡æœ‰è¾“å…¥åˆ¤æ–­çš„é€»è¾‘ã€‚ç„¶åå°†APKæ”¾è¿›æ¨¡æ‹Ÿå™¨è¿è¡Œä¸€ä¸‹ï¼Œçœ‹æœ‰æ²¡æœ‰å•¥å…³é”®è¯ï¼ˆå…¶å®æ··æ·†åå­—ç¬¦ä¸²ä¹‹ç±»çš„å…³é”®è¯å¤§æ¦‚ç‡æ˜¯æœä¸åˆ°çš„ï¼‰ï¼Œå‘ç°è¾“å…¥é”™è¯¯åä¼šæœ‰**Toast**æç¤ºï¼Œæ‰€ä»¥å¯ä»¥å»æœç´¢Toastå…³é”®è¯æ¥æ‰¾åˆ°è¾“å…¥åˆ¤æ–­çš„åœ°æ–¹ã€‚

æœç„¶ï¼Œç”¨Toastå½“å…³é”®è¯æœç´¢æœ‰ç”¨ï¼Œå¦‚ä¸‹å›¾ï¼š

![è¾“å…¥åˆ¤æ–­](https://c.img.dasctf.com/LightPicture/2024/11/4cb492a86197b272.png)

å‘ç°æˆ‘ä»¬çš„è¾“å…¥å…ˆè¿›è¡Œäº†ä¸€ä¸ªæ˜¯å¦ä¸ºç©ºçš„åˆ¤æ–­åï¼Œå†è¿›å…¥äº†ä¸€ä¸ªCheckç±»çš„validateæ–¹æ³•ä¸­å»è¿›è¡Œæœ€ç»ˆåˆ¤æ–­ï¼Œå¦‚æœæ­£ç¡®å°±æç¤ºæ­£ç¡®ä¿¡æ¯ï¼Œå¦åˆ™å°±æç¤ºè¾“å…¥é”™è¯¯ã€‚

è€ŒCheckç±»ä¸‹çš„validateæ˜¯ä¸€ä¸ª**native**æ–¹æ³•ï¼Œæ‰€ä»¥è§£é¢˜å…³é”®æ˜¯åœ¨**soæ–‡ä»¶**ä¸­é€†å‘è¯¥æ–¹æ³•ã€‚

### Nativeå‡½æ•°åˆ†æ

**libcma.so**æ–‡ä»¶æ‹¿å»idaåˆ†æåï¼Œå‘ç°è¿™ä¸ªå‡½æ•°åä¹Ÿè¢«æ··æ·†äº†ï¼Œå°±æ˜¯è¢«æ‹¿å»**JNI_OnLoad**å‡½æ•°ä¸­åŠ¨æ€æ³¨å†Œäº†ï¼Œè¿›æ³¨å†Œè¡¨ä¸­çœ‹æ³¨å†Œçš„å‡½æ•°åï¼Œå‘ç°validateè¢«æ˜ å°„åˆ°äº†ä¸€ä¸ªå«åš**sub_75C**çš„å‡½æ•°ï¼Œå¦‚ä¸‹å›¾ï¼š

![æ³¨å†Œè¡¨](https://c.img.dasctf.com/LightPicture/2024/11/4f1f06949de2b165.png)

æ‰€ä»¥è¿›å…¥**sub_75C**å‡½æ•°å»æŸ¥çœ‹é€»è¾‘ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://c.img.dasctf.com/LightPicture/2024/11/920a951aff641a77.png)

![](https://c.img.dasctf.com/LightPicture/2024/11/9993f83f35a595a9.png)

**å…ˆç»™å‡ºç»“è®ºï¼Œæ•´ä¸ªsub_75Cå‡½æ•°åŒ…æ‹¬äº†SM4å¯†é’¥æ‰©å±•å’ŒSM4åŠ å¯†ï¼Œä¸‹é¢ç»™å‡ºåˆ†æã€‚**



#### SM4å¯†é’¥æ‰©å±•

å…ˆæ¥çœ‹ä¸‹**å¯†é’¥æ‰©å±•**éƒ¨åˆ†çš„ä»£ç ä¹Ÿå°±æ˜¯**sub_904**å‡½æ•°ï¼Œå¦‚ä¸‹å›¾ï¼š

![å¯†é’¥æ‰©å±•](https://c.img.dasctf.com/LightPicture/2024/11/0b2b3f67123ea676.png)

ä¸ºä»€ä¹ˆçœ‹å‡ºæ¥è¿™ä¸ªç®—æ³•æ˜¯SM4ï¼Œè€Œä¸æ˜¯å…¶å®ƒä»€ä¹ˆç®—æ³•ï¼Œå°±æ˜¯å› ä¸ºåœ¨SM4çš„å¯†é’¥æ‰©å±•ä¸­æœ‰ä¸¤ä¸ªä¸å˜çš„å‚æ•°ï¼Œä¸€ä¸ªæ˜¯**ç³»ç»Ÿå‚æ•°FK**ï¼Œå¦ä¸€ä¸ªæ˜¯**å›ºå®šå‚æ•°CK**ã€‚ä»è¿™é‡Œå°±å¯ä»¥åŸºæœ¬åˆ¤æ–­å‡ºè¿™æ˜¯ä¸€ä¸ªSM4åŠ å¯†ç®—æ³•ã€‚

å…¶ä¸­FKå…±æœ‰4ä¸ªï¼Œæ¯ä¸ªéƒ½æœ‰4å­—èŠ‚é•¿ï¼Œå®ƒä»¬çš„å€¼å¦‚ä¸‹ï¼š

```py
FK = [0xa3b1bac6, 0x56aa3350, 0x677d9197, 0xb27022dc]
```

è€ŒCKå…±æœ‰32ä¸ªï¼Œæ¯ä¸ªåŒæ ·æœ‰4å­—èŠ‚é•¿ï¼Œå®ƒä»¬çš„å€¼å¦‚ä¸‹ï¼š

```py
CK = [
    0x00070e15, 0x1c232a31, 0x383f464d, 0x545b6269,
    0x70777e85, 0x8c939aa1, 0xa8afb6bd, 0xc4cbd2d9,
    0xe0e7eef5, 0xfc030a11, 0x181f262d, 0x343b4249,
    0x50575e65, 0x6c737a81, 0x888f969d, 0xa4abb2b9,
    0xc0c7ced5, 0xdce3eaf1, 0xf8ff060d, 0x141b2229,
    0x30373e45, 0x4c535a61, 0x686f767d, 0x848b9299,
    0xa0a7aeb5, 0xbcc3cad1, 0xd8dfe6ed, 0xf4fb0209,
    0x10171e25, 0x2c333a41, 0x484f565d, 0x646b7279
]
```

å…³äºCKçš„å€¼ï¼Œè¿™é‡Œè¦æä¸€å¥ï¼Œidaåç¼–è¯‘å‡ºæ¥çš„ä¼ªCå‡ºæ¥çš„CKâ€˜å€¼å¦‚ä¸‹ï¼š

```py
unsigned int unk_C44[32] = {
    0x00070E12, 0x1C232A36, 0x383F464A, 0x545B626E, 
    0x70777E82, 0x8C939AA6, 0xA8AFB6BA, 0xC4CBD2DE, 
    0xE0E7EEF2, 0xFC030A16, 0x181F262A, 0x343B424E, 
    0x50575E62, 0x6C737A86, 0x888F969A, 0xA4ABB2BE, 
    0xC0C7CED2, 0xDCE3EAF6, 0xF8FF060A, 0x141B222E, 
    0x30373E42, 0x4C535A66, 0x686F767A, 0x848B929E, 
    0xA0A7AEB2, 0xBCC3CAD6, 0xD8DFE6EA, 0xF4FB020E, 
    0x10171E22, 0x2C333A46, 0x484F565A, 0x646B727E
};
```

å¾ˆæ˜æ˜¾CKâ€™ä¸æ˜¯CKï¼Œä½†æ˜¯è¦æ³¨æ„ï¼Œidaä¸­æ˜¯å°†CKâ€˜å¼‚æˆ–äº†7ï¼Œå¼‚æˆ–äº†7ä¹‹åå°±ä¼šå‘ç°ï¼Œå˜æˆäº†åŸCKçš„å€¼ã€‚ç±»ä¼¼çš„å¼‚æˆ–åœ¨åé¢çš„SM4åŠ å¯†ç¯èŠ‚ä¸­è¿˜ä¼šå†å‡ºç°ä¸€æ¬¡ã€‚

å› æ­¤åˆ¤æ–­å‡ºäº†è¿™æ˜¯SM4çš„å¯†é’¥æ‰©å±•ä¹‹åï¼Œåªéœ€è¦æ‰¾åˆ°åŸå¯†é’¥å³å¯ã€‚è€ŒåŸå¯†é’¥åœ¨è¯¥å‡½æ•°çš„å¼€å¤´å°±å·²ç»ç»™å‡ºï¼Œè¿™é‡Œåªéœ€è¦æ³¨æ„æ›¿æ¢å8å­—èŠ‚æ•°æ®æ—¶ï¼Œidaæ˜¯å°ç«¯åºè¾“å…¥ï¼Œæ‰€ä»¥éœ€è¦å°†`Z0099864`å€’å™æ›¿æ¢ã€‚

æ‰€ä»¥åŸå¯†é’¥`key = 4131313232333537343638393930305A`ï¼ˆæˆ‘è¿™é‡Œå·²ç»å†™æˆäº†åå…­è¿›åˆ¶å½¢å¼ï¼‰



#### SM4è½®å‡½æ•°

ç»§ç»­åˆ†æä¸»åŠ å¯†å‡½æ•°**sub_A0C**ï¼Œå¦‚ä¸‹å›¾ï¼š

![ä¸»åŠ å¯†å‡½æ•°](https://c.img.dasctf.com/LightPicture/2024/11/d3d6bd7e80832f7d.png)

è¿™é‡Œé¢çš„ä»£ç æˆ‘è¯¦ç»†è¯´æ˜ä¸­é—´çš„å¾ªç¯éƒ¨åˆ†ï¼š

```c
do
  {
    v11 = v8;                                   // 1
    v8 = v10;                                   // 2
    v10 = v9;                                   // 3
    v12 = v8 ^ v11 ^ v9 ^ *(_DWORD *)(a1 + i);  // å°†1ã€2ã€3ï¼Œè¿™ä¸ªä¸‰ç»„32ä½æ•°æ®å¼‚æˆ–ï¼Œç„¶åå†ä¸å¯†é’¥å¼‚æˆ–
    v13 = byte_CC4[HIBYTE(v12)] ^ 7;            // æ­¤æ—¶å¼‚æˆ–ç»“æœä¸º32ä½ï¼Œç„¶åå†æ‹¿è¿›Sç›’ä¸­å˜æ¢
    v14 = (v13 << 24) | ((byte_CC4[BYTE2(v12)] ^ 7) << 16);
    v15 = v14 & 0xFFFF00FF | ((byte_CC4[BYTE1(v12)] ^ 7) << 8);
    v16 = v15 & 0xFFFFFF00 | byte_CC4[(unsigned __int8)v12] ^ 7;// è¿™å‡ è¡Œçš„&ä¹Ÿå¥½å’Œåé¢çš„|ä¹Ÿå¥½ï¼Œè¿˜æœ‰å·¦ç§»<<ï¼Œéƒ½æ˜¯æ˜¯è¿›è¡Œæ‹¼æ¥çš„æ„æ€ï¼Œå…¶å«ä¹‰å°±æ˜¯å°†ä»Sè¡¨ä¸­å˜æ¢åçš„æ•°æ®^7ä¹‹åå†é‡æ–°æ‹¼æ¥æˆ32ä½æ•°æ®
    HIDWORD(v17) = byte_CC4[(unsigned __int8)v12] ^ 7;// çŒœæµ‹è¿™ä¸¤è¡Œä»£ç åº”è¯¥æ˜¯å¾ªç¯å·¦ç§»24ä½çš„æ„æ€
                                                // v17 = v16 <<< 24
    LODWORD(v17) = v15;
    v9 = v16 ^ v7 ^ (v17 >> 8) ^ ((v13 >> 6) | (4 * v16)) ^ (__PAIR64__(v16, v14) >> 22) ^ (__PAIR64__(v16, v15) >> 14);// mdï¼Œidaçš„ç¼–è¯‘çœŸçš„ç—›è‹¦ï¼Œåˆ†æå‡ºæ¥å°±æ˜¯åŸSM4çš„LåŠ å¯†
    *(_DWORD *)&v22[i] = v9;
    i += 4LL;
    v7 = v11;
  }
  while ( i != 128 );                           // 32è½®åŠ å¯†
```

è®²è§£ä¹‹å‰æœ€å¥½å¯¹SM4ç®—æ³•æœ‰ä¸€å®šäº†è§£ï¼Œå¯ä»¥å»çœ‹ä¸€ä¸‹è¿™ç¯‡å¸–å­[^1]ã€‚

1. é¦–å…ˆæ¥çœ‹ä¸€ä¸‹è¿™å‡ è¡Œä»£ç ï¼š

```c
 	v11 = v8;                                   // 1
    v8 = v10;                                   // 2
    v10 = v9;                                   // 3
    v12 = v8 ^ v11 ^ v9 ^ *(_DWORD *)(a1 + i); 
```

è¿™é‡Œidaæœ‰ç‚¹æ··ä¹±ï¼Œ**å®é™…**ä¸Šåº”è¯¥å¦‚ä¸‹ï¼š

```c
int str[0] = input[0]; //è¿™é‡Œéƒ½ç”¨4å­—èŠ‚intå‹æ¥è£…å¡«æ•°æ®ï¼Œå› ä¸ºSM4è¦æ±‚è¾“å…¥å¿…é¡»æ˜¯128bit
int str[1] = input[1]; //è€ŒSM4åœ¨åŠ å¯†æ—¶ä¼šåˆ†æˆ4ç»„4å­—èŠ‚æ•°æ®æ¥è¿›è¡ŒåŠ å¯†æ“ä½œ
int str[2] = input[2];
int str[3] = input[3];

temp = str[1] ^ str[2] ^ str[3] ^ key[i]; //SM4æ¯ä¸€åŠ å¯†è½®çš„é¦–ç»„4å­—èŠ‚æ•°æ®åªä¼šåœ¨æ¯ä¸€è½®çš„æœ€åå‚ä¸è¿ç®—ï¼Œè€Œæ¯ä¸€åŠ å¯†çš„å¯†é’¥éƒ½ä¸ç›¸åŒã€‚æœ€åtempä¸º32bitæ•°æ®
```



2. å†æ¥çœ‹è¿™å‡ è¡Œä»£ç ï¼š

```c
 	v13 = byte_CC4[HIBYTE(v12)] ^ 7;            // æ­¤æ—¶å¼‚æˆ–ç»“æœä¸º32ä½ï¼Œç„¶åå†æ‹¿è¿›Sç›’ä¸­å˜æ¢
    v14 = (v13 << 24) | ((byte_CC4[BYTE2(v12)] ^ 7) << 16);
    v15 = v14 & 0xFFFF00FF | ((byte_CC4[BYTE1(v12)] ^ 7) << 8);
    v16 = v15 & 0xFFFFFF00 | byte_CC4[(unsigned __int8)v12] ^ 7;// è¿™å‡ è¡Œçš„&ä¹Ÿå¥½å’Œåé¢çš„|ä¹Ÿå¥½ï¼Œè¿˜æœ‰å·¦ç§»<<ï¼Œéƒ½æ˜¯æ˜¯è¿›è¡Œæ‹¼æ¥çš„æ„æ€ï¼Œå…¶å«ä¹‰å°±æ˜¯å°†ä»Sè¡¨ä¸­å˜æ¢åçš„æ•°æ®^7ä¹‹åå†é‡æ–°æ‹¼æ¥æˆ32ä½æ•°æ®
```

è¿™é‡Œidaä¹Ÿåç¼–è¯‘å¾—å¾ˆä¹±ï¼Œ**å®é™…**ä¸Šåº”è¯¥å¦‚ä¸‹ï¼š

```c
   temp[0] = S[temp[0]&0xF0][temp[0]&0x0F] ^ 7; //ä¹Ÿå°±æ˜¯å°†32bitçš„tempï¼Œå†æ¬¡åˆ†æˆ4ç»„8bitæ•°æ®ï¼Œç„¶åå°†æ¯ç»„8bitä¸­çš„é«˜4ä½åšä¸ºè¡Œï¼Œä½4ä½ä½œä¸ºåˆ—ï¼Œç„¶åæ‹¿è¿™ä¸ªå½“æˆåæ ‡å»Sè¿™ä¸ªè¡¨ä¸­å»å¯»å€¼ï¼Œæœ€åå°†å¯»åˆ°çš„å€¼å†å¼‚æˆ–7ä¹‹åé‡æ–°èµ‹ç»™temp[0]ï¼Œè€Œè¿™é‡Œçš„å¼‚æˆ–ä¹Ÿæ˜¯æœ¬é¢˜å¯¹SM4ç®—æ³•çš„æ”¹åŠ¨ä¹‹ä¸€ï¼ˆå¼‚æˆ–å®Œä¹‹åï¼Œä¼šå‘ç°å°±æ˜¯åŸSM4çš„Sç›’ï¼‰
   temp[1] = S[temp[1]&0xF0][temp[1]&0x0F] ^ 7;
   temp[2] = S[temp[2]&0xF0][temp[2]&0x0F] ^ 7;
   temp[3] = S[temp[3]&0xF0][temp[3]&0x0F] ^ 7;
```

ä½ é—®æˆ‘ä¸ºä»€ä¹ˆæ˜¯æ€ä¹ˆè¿˜åŸè¿™é‡Œçš„é€»è¾‘çš„ï¼Œæ‹¿è‰ç¨¿è‡ªå·±ç®—ä¸€éï¼šç”±äºv13åœ¨idaä¸­æ˜¯ä¸€ä¸ªint8ç±»å‹çš„æ•°æ®ï¼Œv14ã€v15ã€v16éƒ½æ˜¯intç±»å‹ï¼ŒåŒæ—¶`HIBYTE(v12)`çš„æ„æ€æ˜¯å–æœ€é«˜8ä½çš„æ•°æ®ï¼Œ`BYTE2(v12)`æ˜¯å–æ¬¡é«˜8ä½æ•°æ®ï¼Œ`byte_CC4[BYTE1(v12)`ä»¥æ­¤ç±»æ¨æ˜¯å–æ¬¡ä½8ä½æ•°æ®ï¼Œ`(unsigned __int8)v12`æ˜¯å–æœ€ä½8ä½æ•°æ®ï¼Œå…¶æ¬¡å½“v13å·¦ç§»24ä½æ—¶ï¼Œä¸å°±æ˜¯å°†å®ƒçš„8ä½æ•°æ®ç§»åˆ°32ä½ï¼ˆå› ä¸ºv14æ˜¯intç±»å‹ï¼‰çš„æœ€é«˜8ä½å˜›ï¼Œç„¶åå°†è¯¥æ•°æ®`æˆ–è¿ç®—|` ä¸€ä¸ªå·¦ç§»16ä½çš„æ•°æ®ï¼Œå°±æ˜¯å°†è¯¥8ä½æ•°æ®ä¸å‰8ä½æ•°æ®æ‹¼æ¥åœ¨ä¸€èµ·ç»„æˆ32ä½æ•°æ®çš„å‰16ä½â€¦â€¦æ‰€ä»¥æ‹¿è‰ç¨¿è‡ªå·±æ¨¡æ‹Ÿä¸€éï¼Œé€»è¾‘å°±å¾ˆæ¸…æ™°äº†ã€‚åä¸¤è¡Œä»£ç é€»è¾‘å’Œå‰é¢ä¸€æ ·éƒ½æ˜¯æ‹¼æ¥é€»è¾‘ï¼Œç„¶åç»„æˆä¸€ä¸ªæ–°32ä½æ•°æ®ã€‚



3. æ¥ç€å†çœ‹è¿™å‡ è¡Œä»£ç ï¼š

```c
	HIDWORD(v17) = byte_CC4[(unsigned __int8)v12] ^ 7;// æˆ‘çŒœæµ‹è¿™ä¸¤è¡Œä»£ç åº”è¯¥æ˜¯å¾ªç¯å·¦ç§»24ä½çš„æ„æ€, v17 = v16 <<< 24
    LODWORD(v17) = v15;
    v9 = v16 ^ v7 ^ (v17 >> 8) ^ ((v13 >> 6) | (4 * v16)) ^ (__PAIR64__(v16, v14) >> 22) ^ (__PAIR64__(v16, v15) >> 14);// mdï¼Œidaçš„ç¼–è¯‘çœŸçš„ç—›è‹¦ï¼Œåˆ†æå‡ºæ¥å°±æ˜¯åŸSM4çš„LåŠ å¯†ï¼ˆè¿™é‡Œçš„ä»£ç çœ‹æ±‡ç¼–ä¼šæ›´å®¹æ˜“åˆ†æï¼‰
```

è¿™é‡Œçš„ä»£ç ç›¸å½“é¬¼ï¼Œidaçš„åç¼–è¯‘æœ‰æ—¶å€™å°±æ˜¯è¿™ä¹ˆç—›è‹¦ï¼Œæ˜æ˜ä¸€ä¸ªç®€å•çš„ä»£ç éƒ½èƒ½è¢«ç¼–è¯‘æˆè¿™ä¸ªæ ·å­â€¦â€¦

è¿™é‡Œçš„é€»è¾‘å¤§è‡´æ¢³ç†ä¸€ä¸‹ï¼šv17æ˜¯ä¸€ä¸ªint64ç±»å‹çš„æ•°æ®ï¼Œå¯¹æ¯”æˆ‘ä¸Šé¢å†™çš„tempï¼Œå¤§æ¦‚å°±æ˜¯å°†åŸ32ä½æ•°æ®`temp[0]ã€temp[1]ã€temp[2]ã€temp[3]`ï¼Œè°ƒæ¢åŸæœ€ä½8ä½æ•°æ®ä½ç½®åˆ°ç°é«˜32ä½çš„æœ€ä½8ä½ï¼Œå³**å˜æˆ**å¦‚ä¸‹ï¼š

`0ã€0ã€0ã€temp[3]ã€temp[0]ã€temp[1]ã€temp[2]ã€0`ï¼Œè¿™æ ·çš„64ä½æ•°æ®ï¼Œå…¶ä¸­0ä»£è¡¨æ•´ä¸ªå­—èŠ‚éƒ½ä¸º0ï¼Œç„¶åå†å°†è¯¥æ•°æ®ä¹Ÿå°±æ˜¯v17å³ç§»8ä½ï¼Œä¹Ÿå°±æ˜¯**å˜æˆ**å¦‚ä¸‹ï¼š

`0ã€0ã€0ã€0ã€temp[3]ã€temp[0]ã€temp[1]ã€temp[2]`ï¼Œè¿™æ ·çš„64ä½æ•°æ®ï¼Œè¯´ç™½äº†å°±æ˜¯å°†åŸ32ä½tempå¾ªç¯å·¦ç§»24ä½ï¼Œå³ï¼š**`temp<<<24`**ã€‚

åŒæ ·çš„åé¢çš„`((v13 >> 6) | (4 * v16))`ï¼Œå°±æ˜¯å°†tempå¾ªç¯å·¦ç§»2ä½ï¼Œå³ï¼š**`temp<<<2`**ã€‚

è€Œ`(__PAIR64__(v16, v14) >> 22)`ï¼Œå°±æ˜¯å°†tempå¾ªç¯å·¦ç§»10ä½ï¼Œå³ï¼š**`temp<<<10`**ï¼Œè¿™é‡Œè¦è¯´æ˜ä¸€ä¸‹`(__PAIR64__(v16, v14) >> 22)`æ˜¯ä»€ä¹ˆæ„æ€ï¼Œè¿™é‡Œæ˜¯idaçš„ç‰¹æ®Šå†™æ³•ï¼Œå®ƒçš„ç­‰æ•ˆä»£ç å¯ä»¥å†™åšå¦‚ä¸‹ï¼š

```c
uint64_t combined = ((uint64_t)v16 << 32) | v14;
uint64_t result = combined >> 22;
```

è¿™é‡Œè¿˜æ˜¯è¦æ‹¿è‰ç¨¿è®¡ç®—ä¸€ä¸‹ï¼Œç”±äºè¿™é‡Œè¢«è½¬æˆäº†64ä½æ•°æ®ï¼Œæ‰€ä»¥æœ€åè¿˜éœ€è¦å°†ä¸Šè¿°è¿‡ç¨‹å½¢æˆçš„64ä½æ•°æ®é‡æ–°è½¬æˆ32ä½ï¼Œä¹Ÿå°±æ˜¯è¯´é«˜ä½æ•°æ®**å¤šå‡ºçš„**éƒ¨åˆ†**è¦ä¸¢å¼ƒ**ã€‚

æœ€åçš„`(__PAIR64__(v16, v15) >> 14)`ï¼Œå°±æ˜¯å°†tempå¾ªç¯å·¦ç§»18ä½ï¼Œå³ï¼š**`temp<<<18`**ã€‚

æ‰€ä»¥ç¬¬3éƒ¨åˆ†çš„ä»£ç **å®é™…**å¦‚ä¸‹ï¼š

```c
_temp_ = str[0] ^ temp ^ (temp<<<2) ^ (temp<<<10) ^ (temp<<<18) ^ (temp<<<24);
```



4. æœ€åå†æ¥çœ‹è¿™éƒ¨åˆ†çš„ä»£ç ï¼š

```c
 	*(_DWORD *)&v22[i] = v9;
    i += 4LL;
    v7 = v11;
```

è¿™éƒ¨åˆ†çš„ä»£ç åŒ…æ‹¬äº†å¾ªç¯é€’å¢ä»¥åŠæ•°æ®çš„åç§»å˜åŒ–ï¼Œä¸Šé¢ä¹Ÿè¯´äº†æˆ‘ä»¬çš„è¾“å…¥æ˜¯128bitï¼Œè€Œæ¯ä¸€è½®åŠ å¯†ç»“æŸéƒ½ä¼šæ–°å¢ä¸€ä¸ª32ä½æ•°æ®åˆ°åŸæ•°æ®çš„æœ«å°¾ï¼Œä¸ºäº†ç¡®ä¿æ¯ä¸€è½®åŠ å¯†éƒ½æ˜¯128bitï¼Œæ‰€ä»¥æ¯ä¸€è½®åŠ å¯†åï¼Œå¾…åŠ å¯†æ•°æ®éƒ½ä¼šå‘ååç§»32bitã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

ç¬¬ä¸€è½®å¾…åŠ å¯†æ•°æ®å¦‚ä¸‹ï¼šï¼ˆæ¯ä¸ªstr[]éƒ½æ˜¯32bitæ•°æ®ï¼‰

`str[0] str[1] str[2] str[3]`

ç¬¬ä¸€è½®åŠ å¯†ç»“æŸåçš„æ•°æ®å¦‚ä¸‹ï¼š

`str[0] str[1] str[2] str[3] Str[4]`ï¼Œå…¶ä¸­`str[4]`æ˜¯ç¬¬ä¸€è½®åŠ å¯†ç»“æœ

ç¬¬äºŒè½®å¾…åŠ å¯†æ•°æ®å¦‚ä¸‹ï¼šï¼ˆæ¯è½®åŠ å¯†ç»“æŸåå‘åç§»åŠ¨32bitï¼‰

`str[1] str[2] str[3] Str[4]`

ä»¥æ­¤ç±»æ¨â€¦â€¦æ‰§è¡Œ32è½®åŠ å¯†ï¼Œå–æœ€å4ä¸ª32bitæ•°æ®ï¼Œå†å€’åºï¼Œä½œä¸ºåŠ å¯†ç»“æœã€‚



### è§£å¯†

æœ€åéœ€è¦æ¯”å¯¹çš„æ­£ç¡®å¯†æ–‡åœ¨idaè§£æåä¹Ÿä¸éš¾æ‰¾åˆ°ï¼Œ**æ­£ç¡®çš„å¯†æ–‡**å†…å®¹å¦‚ä¸‹ï¼š

```py
A27C84EDE57F4EDE9D977F6C69339F2752E6067920A2C3B7A6BE2B4A6231650C51160EF0A39807DD8F40CF021D482310
```

å‰©ä¸‹çš„å°±åªæœ‰è§£å¯†äº†ï¼Œæœ€åé™„ä¸Šä¸€ä¸ªSM4è§£å¯†è„šæœ¬ï¼š

```py
S_BOX = [0xd1, 0x97, 0xee, 0xf9, 0xcb, 0xe6, 0x3a, 0xb0, 0x11, 0xb1, 0x13, 0xc5, 0x2f, 0xfc, 0x2b, 0x2, 0x2c, 0x60, 0x9d, 0x71, 0x2d, 0xb9, 0x3, 0xc4, 0xad, 0x43, 0x14, 0x21, 0x4e, 0x81, 0x1, 0x9e, 0x9b, 0x45, 0x57, 0xf3, 0x96, 0xe8, 0x9f, 0x7d, 0x34, 0x53, 0xc, 0x44, 0xea, 0xc8, 0xab, 0x65, 0xe3, 0xb4, 0x1b, 0xae, 0xce, 0xf, 0xef, 0x92, 0x87, 0xd8, 0x93, 0xfd, 0x72, 0x88, 0x38, 0xa1, 0x40, 0x0, 0xa0, 0xfb, 0xf4, 0x74, 0x10, 0xbd, 0x84, 0x5e, 0x3b, 0x1e, 0xe1, 0x82, 0x48, 0xaf, 0x6f, 0x6c, 0x86, 0xb5, 0x76, 0x63, 0xdd, 0x8c, 0xff, 0xec, 0x8, 0x4c, 0x77, 0x51, 0x9a, 0x32, 0x19, 0x23, 0x9, 0x59, 0x64, 0x5f, 0xd6, 0xa5, 0x22, 0x25, 0x7b, 0x3c, 0x6, 0x26, 0x7f, 0x80, 0xd3, 0x7, 0x41, 0x50, 0x98, 0xd4, 0x20, 0x55, 0x4b, 0x31, 0x5, 0xe0, 0xa7, 0xc3, 0xcf, 0x99, 0xed, 0xb8, 0x8d, 0xd5, 0x47, 0xc0, 0x3f, 0xb2, 0xa4, 0xf0, 0xf5, 0xc9, 0xfe, 0x66, 0x12, 0xa6, 0xe7, 0xa9, 0x5a, 0xa3, 0x9c, 0x33, 0x1d, 0x52, 0xaa, 0x94, 0x35, 0x37, 0xf2, 0x8b, 0xb6, 0xe4, 0x1a, 0xf1, 0xe5, 0x29, 0x85, 0x61, 0xcd, 0x67, 0xc7, 0x2e, 0x24, 0xac, 0xa, 0x54, 0x49, 0x68, 0xd2, 0xdc, 0x30, 0x42, 0xd9, 0xfa, 0x89, 0x28, 0x4, 0xf8, 0x6d, 0x75, 0x6a, 0x6b, 0x5c, 0x56, 0x8a, 0x1c, 0xa8, 0x95, 0xbc, 0xda, 0xbb, 0x78, 0x16, 0xde, 0x5b, 0x46, 0x18, 0x17, 0x5d, 0xdf, 0xd, 0xc6, 0x36, 0x8f, 0xa2, 0xca, 0x7c, 0xba, 0x2a, 0x73, 0xd7, 0x15, 0xbf, 0xe2, 0xb3, 0xb7, 0x8e, 0x6e, 0x90, 0x4d, 0xb, 0x91, 0x70, 0x79, 0x62, 0xbe, 0xf6, 0xe, 0xc2, 0x69, 0xc1, 0x83, 0x1f, 0xf7, 0x7a, 0xeb, 0x3d, 0xdb, 0x4a, 0x27, 0x7e, 0xe9, 0x58, 0x39, 0xd0, 0xcc, 0x3e, 0x4f]
# æ¢ä¸ºSç›’

for i in range(len(S_BOX)):
    S_BOX[i] ^= 7

FK = [0xa3b1bac6, 0x56aa3350, 0x677d9197, 0xb27022dc]
CK = [
    0x00070e15, 0x1c232a31, 0x383f464d, 0x545b6269,
    0x70777e85, 0x8c939aa1, 0xa8afb6bd, 0xc4cbd2d9,
    0xe0e7eef5, 0xfc030a11, 0x181f262d, 0x343b4249,
    0x50575e65, 0x6c737a81, 0x888f969d, 0xa4abb2b9,
    0xc0c7ced5, 0xdce3eaf1, 0xf8ff060d, 0x141b2229,
    0x30373e45, 0x4c535a61, 0x686f767d, 0x848b9299,
    0xa0a7aeb5, 0xbcc3cad1, 0xd8dfe6ed, 0xf4fb0209,
    0x10171e25, 0x2c333a41, 0x484f565d, 0x646b7279
]


def wd_to_byte(wd, bys):
    bys.extend([(wd >> i) & 0xff for i in range(24, -1, -8)])


def bys_to_wd(bys):
    ret = 0
    for i in range(4):
        bits = 24 - i * 8
        ret |= (bys[i] << bits)
    return ret


def s_box(wd):
    """
    è¿›è¡Œéçº¿æ€§å˜æ¢ï¼ŒæŸ¥Sç›’
    :param wd: è¾“å…¥ä¸€ä¸ª32bitså­—
    :return: è¿”å›ä¸€ä¸ª32bitså­—   ->int
    """
    ret = []
    for i in range(0, 4):
        byte = (wd >> (24 - i * 8)) & 0xff
        row = byte >> 4
        col = byte & 0x0f
        index = (row * 16 + col)
        ret.append(S_BOX[index])
    return bys_to_wd(ret)


def rotate_left(wd, bit):
    """
    :param wd: å¾…ç§»ä½çš„å­—
    :param bit: å¾ªç¯å·¦ç§»ä½æ•°
    :return:
    """
    return (wd << bit & 0xffffffff) | (wd >> (32 - bit))



def Linear_transformation(wd):
    """
    è¿›è¡Œçº¿æ€§å˜æ¢L
    :param wd: 32bitsè¾“å…¥
    """
    return wd ^ rotate_left(wd, 2) ^ rotate_left(wd, 10) ^ rotate_left(wd, 18) ^ rotate_left(wd, 24)


def Tx(k1, k2, k3, ck):
    """
    å¯†é’¥æ‰©å±•ç®—æ³•çš„åˆæˆå˜æ¢
    """
    xor = k1 ^ k2 ^ k3 ^ ck
    t = s_box(k1 ^ k2 ^ k3 ^ ck)
    return t ^ rotate_left(t, 13) ^ rotate_left(t, 23)


def T(x1, x2, x3, rk):
    """
    åŠ å¯†ç®—æ³•è½®å‡½æ•°çš„åˆæˆå˜æ¢
    """
    t = x1 ^ x2 ^ x3 ^ rk
    t = s_box(t)
    return t ^ rotate_left(t, 2) ^ rotate_left(t, 10) ^ rotate_left(t, 18) ^ rotate_left(t, 24)


def key_extend(main_key):
    MK = [(main_key >> (128 - (i + 1) * 32)) & 0xffffffff for i in range(4)]
    # å°†128bitsåˆ†ä¸º4ä¸ªå­—
    keys = [FK[i] ^ MK[i] for i in range(4)]
    # ç”ŸæˆK0~K3
    RK = []
    for i in range(32):
        t = Tx(keys[i + 1], keys[i + 2], keys[i + 3], CK[i])
        k = keys[i] ^ t
        keys.append(k)
        RK.append(k)
    return RK


def R(x0, x1, x2, x3):
    # ä½¿ç”¨ä½è¿ç®—ç¬¦å°†æ•°å€¼é™åˆ¶åœ¨32ä½èŒƒå›´å†…
    x0 &= 0xffffffff
    x1 &= 0xffffffff
    x2 &= 0xffffffff
    x3 &= 0xffffffff
    s = f"{x3:08x}{x2:08x}{x1:08x}{x0:08x}"
    return s


def encode(plaintext, rk):
    X = [plaintext >> (128 - (i + 1) * 32) & 0xffffffff for i in range(4)]
    for i in range(32):
        t = T(X[1], X[2], X[3], rk[i])
        c = (t ^ X[0])
        X = X[1:] + [c]
    ciphertext = R(X[0], X[1], X[2], X[3])
    # è¿›è¡Œååºå¤„ç†
    return ciphertext


def decode(ciphertext, rk):
    ciphertext = int(ciphertext, 16)
    X = [ciphertext >> (128 - (i + 1) * 32) & 0xffffffff for i in range(4)]
    for i in range(32):
        t = T(X[1], X[2], X[3], rk[31 - i])
        c = (t ^ X[0])
        X = X[1:] + [c]
    m = R(X[0], X[1], X[2], X[3])
    return m


def output(s, name):
    out = ""
    for i in range(0, len(s), 2):
        out += s[i:i + 2] + " "
    print(f"{name}:", end="")
    print(out.strip())

def output2(s, name):
    out = ""
    for i in range(0, len(s), 2):
        out += chr(eval('0x'+s[i:i + 2]))
    print(f"{name}", end="")
    print(out, end='')
    # print(out)

if __name__ == '__main__':
    key = '4131313232333537343638393930305A' 
    main_key = eval('0x'+key)
    rk = key_extend(main_key)
    print("è§£å¯†:")
    cipher = 'A27C84EDE57F4EDE9D977F6C69339F2752E6067920A2C3B7A6BE2B4A6231650C51160EF0A39807DD8F40CF021D482310'
    for i in range(len(cipher) // 32):
        ciphertext = cipher[32*i: 32*(i+1)]
        # print(ciphertext)
        m = decode(ciphertext, rk)
        output2(m, "")
```

å‡ºæ¥çš„ç»“æœä¸ºï¼š`flag{eb83c643-d0ee-4db6-bc35-96e11283bd21}`



---

## REVERSE02

è¿™é“é¢˜æ¯”è¾ƒç®€å•ï¼Œæ ¹æ®æç¤ºï¼Œè¿™é“é¢˜åº”è¯¥æœ‰4å±‚åŠ å¯†ã€‚

æ‹–å…¥idaä¸­æŸ¥çœ‹ï¼Œå‘ç°å¯¹å­—ç¬¦ä¸²æ ¼å¼è¿›è¡Œäº†æ ¡éªŒï¼Œå¦‚ä¸‹å›¾ï¼š

![æ ¼å¼æ ¡éªŒéƒ¨åˆ†](https://c.img.dasctf.com/LightPicture/2024/10/44383559dc619edd.png)

åŒæ—¶æ ¹æ®èµ›é¢˜æç¤ºä¸ä¼ªä»£ç çš„åˆ†æï¼Œå‘ç°æœ‰4å±‚ç®€å•åŠ å¯†ï¼Œå¦‚ä¸‹å›¾ï¼š

![4å±‚åŠ å¯†](https://c.img.dasctf.com/LightPicture/2024/10/2e3f958e35e833c5.png)

### åŠ å¯†åˆ†æ

**ç¬¬ä¸€å±‚**åŠ å¯†:

å°†å­—ç¬¦ä¸²çš„å‰8ä½å·¦ç§»1ä½åŠ å¯†ã€‚

**ç¬¬äºŒå±‚**åŠ å¯†ï¼š

å°±æ˜¯å°†å­—ç¬¦ä¸²çš„ç¬¬9ä½åˆ°ç¬¬16ä½ä¸`XorrLord`è¿›è¡Œå¼‚æˆ–ï¼Œç„¶åä¸ä¸‹é¢è¿™8å­—èŠ‚æ•°æ®è¿›è¡Œæ ¡éªŒï¼š

```c
0x60,0x58,0x16,0x47,0x7d,0x5c,0x44,0x5d
```

**ç¬¬ä¸‰å±‚**åŠ å¯†ï¼š

å°†å­—ç¬¦ä¸²çš„ç¬¬17ä½åˆ°ç¬¬24ä½è¿›è¡Œæ¢è¡¨base64åŠ å¯†ï¼Œæœ€åä¸`BFO1AjdmPmG`è¿›è¡Œæ¯”è¾ƒï¼Œæ˜ å°„è¡¨å¦‚ä¸‹ï¼š

```c
CDEFGHIJKLMNOPQRSTUVWXYZABabcdefghijklmnopqrstuvwxyz0123456789+/
```

**ç¬¬å››å±‚**åŠ å¯†ï¼š

å°†å­—ç¬¦ä¸²æœ€å8ä½æ•°æ®è¿›è¡ŒAESåŠ å¯†ï¼Œå¯†é’¥ä¸º`AesMasterAesMast`ï¼Œæœ€åä¸ä¸‹é¢16å­—èŠ‚æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼š

```c
0xF, 0xE3, 0x2F, 0xE6, 0x58, 0x20, 0x9B, 0x3A, 0xD6, 0xE4, 0x18, 0x3F, 0xA7, 0x78,0xA5, 0x82
```

æœ€ååˆ†åˆ«å†™å‡ºè§£å¯†è„šæœ¬ï¼Œæˆ‘è¿™é‡Œä»æœ€åä¸€å±‚å¼€å§‹è§£å¯†ã€‚ï¼ˆå…¶å®å¯ä»¥ä¸€ä¸ªè„šæœ¬å…¨éƒ¨å†™å®Œï¼Œä¸»è¦æ˜¯æ‡’å¾—å†™äº†ğŸ¥´ï¼‰

### è§£å¯†

**ç¬¬å››å±‚**è§£å¯†ï¼š

```py
from Crypto.Cipher import AES

# åŠ å¯†çš„ 16 å­—èŠ‚æ•°æ®
encrypted_data = bytes([
    0xF, 0xE3, 0x2F, 0xE6,
    0x58, 0x20, 0x9B, 0x3A,
    0xD6, 0xE4, 0x18, 0x3F,
    0xA7, 0x78, 0xA5, 0x82
])

# åŸå¯†é’¥ï¼ˆ16 å­—èŠ‚ï¼‰
key = b"AesMasterAesMast"

# ä½¿ç”¨ AES è§£å¯†ï¼ˆECB æ¨¡å¼ï¼‰
cipher = AES.new(key, AES.MODE_ECB)

# è§£å¯†æ•°æ®
decrypted_data = cipher.decrypt(encrypted_data)

# å°†è§£å¯†åçš„æ•°æ®æŒ‰å­—èŠ‚è¾“å‡ºä¸ºåå…­è¿›åˆ¶
hex_output = " ".join(f"{byte:02x}" for byte in decrypted_data)
print("è§£å¯†åçš„åå…­è¿›åˆ¶æ•°æ®:", hex_output)
```

å¾—åˆ°`61 64 32 65 34 35 36 31`

ï¼ˆå…¶å®ä¸Šé¢çš„ç»“æœåé¢è¿˜ä¼šè·Ÿä¸Š8ä¸ª8ï¼Œä½†æ˜¯æ ¹æ®æºç åˆ†æï¼Œåªæœ‰å‰8å­—èŠ‚æ‰æœ‰ç”¨ï¼‰

**ç¬¬ä¸‰å±‚**è§£å¯†ï¼š

```c
import base64

# ç¤ºä¾‹çš„ base64 æ•°æ®ï¼ˆæ›¿æ¢ä¸ºä½ çš„æ•°æ®ï¼‰
encoded_data = "BFO1AjdmPmG"

# è‡ªå®šä¹‰çš„ base64 å­—ç¬¦æ˜ å°„è¡¨
custom_base64_table = "CDEFGHIJKLMNOPQRSTUVWXYZABabcdefghijklmnopqrstuvwxyz0123456789+/"  # è‡ªå®šä¹‰æ˜ å°„è¡¨
standard_base64_table = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"

# æ„å»ºè‡ªå®šä¹‰ base64 è§£ç è¡¨
translation_table = str.maketrans(custom_base64_table, standard_base64_table)
translated_data = encoded_data.translate(translation_table)

# æ£€æŸ¥å¹¶ä¿®å¤å¡«å……
missing_padding = len(translated_data) % 4
if missing_padding:
    translated_data += "=" * (4 - missing_padding)  # æ·»åŠ å¿…è¦çš„å¡«å……

# ä½¿ç”¨æ ‡å‡† base64 è§£ç 
try:
    decoded_data = base64.b64decode(translated_data)
    # å°†è§£ç åçš„æ•°æ®æŒ‰å­—èŠ‚è½¬æ¢ä¸ºåå…­è¿›åˆ¶å¹¶é€ä¸ªè¾“å‡º
    hex_output = " ".join(f"{byte:02x}" for byte in decoded_data)
    print("è§£ç åçš„åå…­è¿›åˆ¶æ•°æ®:", hex_output)
except base64.binascii.Error as e:
    print("è§£ç é”™è¯¯:", e)

```

å¾—åˆ°`64 33 35 62 37 66 36 61`

**ç¬¬äºŒä¸ç¬¬ä¸€å±‚**è§£å¯†ï¼š

```c
#include <stdio.h>
int main()
{
	unsigned char str1[] = {0x6A,0x0C4,0x0CC,0x62,0x0C2,0x6E,0x0CA,0x0CA};
	char temp1[9];
	for(int i=0;i<8;i++)
	{
		temp1[i] = str1[i] >> 1;
		printf("%x ",temp1[i]);
	}
	
	printf("\n");
	
	char str2[] = {0x60,0x58,0x16,0x47,0x7d,0x5c,0x44,0x5d};
	char* xorr = "XorrLord";
	char temp2[9];
	for(int i=0;i<8;i++)
	{
		temp2[i] = str2[i] ^ xorr[i];
		printf("%x ",temp2[i]);
	}
	
	printf("\n");
	
	unsigned char test[] = {0x35 ,0x62 ,0x66 ,0x31 ,0x61 ,0x37 ,0x65 ,0x65};
	unsigned char temp[9];
	for(int i=0;i<8;i++)
	{
		temp[i] = test[i] << 1;
		printf("%x ",temp[i]);
	}
	
	
	return 0;
}
```

ç„¶åä¾æ¬¡è¿æ¥ä»¥ä¸Šå››éƒ¨åˆ†æ•°æ®ç„¶åè½¬æˆasciiç è·å–flag

æœ€åå°†æ•°æ®æ±‡æ€»è½¬æˆflagå³å¯ï¼š**`wdbflag{5bf1a7ee87d51369d35b7f6aad2e4561}`**

## å‚è€ƒé“¾æ¥

[^1]:[https://www.cnblogs.com/11sgXL/p/13626483.html](https://www.cnblogs.com/11sgXL/p/13626483.html)

